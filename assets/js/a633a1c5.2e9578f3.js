"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[870],{9558:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var t=s(4848),i=s(8453);const a={title:"Azure configuration",sidebar_position:1},o=void 0,r={id:"b2c/azure_setup",title:"Azure configuration",description:"We'll need to create two application registrations for Azure Entra ID B2C authentication to cover both direct API",source:"@site/docs/b2c/azure_setup.mdx",sourceDirName:"b2c",slug:"/b2c/azure_setup",permalink:"/fastapi-azure-auth/b2c/azure_setup",draft:!1,unlisted:!1,editUrl:"https://github.com/Intility/FastAPI-Azure-Auth/edit/main/docs/docs/b2c/azure_setup.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Azure configuration",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Accept specific tenants only",permalink:"/fastapi-azure-auth/multi-tenant/accept_specific_tenants_only"},next:{title:"FastAPI configuration",permalink:"/fastapi-azure-auth/b2c/fastapi_configuration"}},d={},c=[{value:"Backend API",id:"backend-api",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration",level:3},{value:"Step 2 - Verify token version is <code>v2</code>",id:"step-2---verify-token-version-is-v2",level:3},{value:"Step 3 - Note down your tenant name and application ID",id:"step-3---note-down-your-tenant-name-and-application-id",level:3},{value:"Step 4 - Add an application scope",id:"step-4---add-an-application-scope",level:3},{value:"OpenAPI Documentation",id:"openapi-documentation",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration-1",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids",level:3},{value:"Step 4 - Allow OpenAPI to talk to the backend",id:"step-4---allow-openapi-to-talk-to-the-backend",level:3},{value:"User flows",id:"user-flows",level:2},{value:"Step 1 - Create a user flow",id:"step-1---create-a-user-flow",level:3},{value:"Step 2 - Note down your User flow name",id:"step-2---note-down-your-user-flow-name",level:3}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"We'll need to create two application registrations for Azure Entra ID B2C authentication to cover both direct API\nuse and usage from the OpenAPI (swagger) documentation."}),"\n",(0,t.jsx)(n.admonition,{type:"info",children:(0,t.jsx)(n.p,{children:"This guide assumes that an Azure B2C tenant was already created and linked to an Azure subscription."})}),"\n",(0,t.jsx)(n.h2,{id:"backend-api",children:"Backend API"}),"\n",(0,t.jsx)(n.h3,{id:"step-1---create-app-registration",children:"Step 1 - Create app registration"}),"\n",(0,t.jsxs)(n.p,{children:["Head over to\n",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/registeredApps",children:"Azure -> Azure Entra ID B2C -> App registrations"}),",\nand create a new registration."]}),"\n",(0,t.jsx)(n.p,{children:"Select a fitting name for your project; Azure will present the name to the user during consent."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Supported account types"}),": ",(0,t.jsx)(n.code,{children:"Accounts in any identity provider or organizational directory (for authenticating users with user flows)"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Redirect URI"}),": Choose ",(0,t.jsx)(n.code,{children:"Web"})," and ",(0,t.jsx)(n.code,{children:"http://localhost:8000/signin-oidc"})," as a value"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Grant admin consent to openid and offline_access permissions"}),": ",(0,t.jsx)(n.code,{children:"Yes"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Register"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"1_application_registration",src:s(235).A+"",width:"1181",height:"620"})}),"\n",(0,t.jsxs)(n.h3,{id:"step-2---verify-token-version-is-v2",children:["Step 2 - Verify token version is ",(0,t.jsx)(n.code,{children:"v2"})]}),"\n",(0,t.jsxs)(n.p,{children:["First we'll verify that the token version is version 2. In the left menu bar, click ",(0,t.jsx)(n.code,{children:"Manifest"})," and find the line\nthat says ",(0,t.jsx)(n.code,{children:"requestedAccessTokenVersion"}),". Verify that the value is ",(0,t.jsx)(n.code,{children:"2"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Save"})]}),"\n",(0,t.jsx)(n.p,{children:"(A change can take some time to happen, which is why we do this first.)"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"2_manifest",src:s(7015).A+"",width:"956",height:"833"})}),"\n",(0,t.jsx)(n.h3,{id:"step-3---note-down-your-tenant-name-and-application-id",children:"Step 3 - Note down your tenant name and application ID"}),"\n",(0,t.jsxs)(n.p,{children:["Go back to the App Registration ",(0,t.jsx)(n.code,{children:"Overview"}),", found in the left menu."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"3_overview",src:s(4350).A+"",width:"928",height:"343"})}),"\n",(0,t.jsxs)(n.p,{children:["Copy the ",(0,t.jsx)(n.code,{children:"Application (Client) ID"}),", we'll need it for later. I like to use ",(0,t.jsx)(n.code,{children:".env"})," files to\nstore variables like these:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {2}',children:"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Also, in the Azure Entra ID B2C overview get the tenant name from the domain name (without the ",(0,t.jsx)(n.code,{children:".onmicrosoft.com"})," part)\nand add it to the ",(0,t.jsx)(n.code,{children:".env"})," file as well:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {1}',children:"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-4---add-an-application-scope",children:"Step 4 - Add an application scope"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Go to ",(0,t.jsx)(n.strong,{children:"Expose an API"})," in the left menu bar under your app registration."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"+ Add a scope"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["You'll be prompted to set an Application ID URI, leave the suggested one and press ",(0,t.jsx)(n.strong,{children:"Save and continue"}),"\n",(0,t.jsx)(n.img,{alt:"4_add_scope",src:s(3116).A+"",width:"1137",height:"560"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["You'll be prompted to set a scope name, display name and description. Set the scope name to ",(0,t.jsx)(n.code,{children:"user_impersonation"}),",\ndisplay name to ",(0,t.jsx)(n.code,{children:"Access API as user"})," and description to ",(0,t.jsx)(n.code,{children:"Allows the app to access the API as the user."})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Make sure the State is ",(0,t.jsx)(n.code,{children:"Enabled"})]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Add scope"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"5_add_scope_props",src:s(3402).A+"",width:"573",height:"535"})}),"\n",(0,t.jsx)(n.h2,{id:"openapi-documentation",children:"OpenAPI Documentation"}),"\n",(0,t.jsxs)(n.p,{children:["Our OpenAPI documentation will use the ",(0,t.jsx)(n.code,{children:"Authorization Code Grant Flow, with Proof Key for Code Exchange"})," flow.\nIt's a flow that enables a user of a Single-Page Application to safely log in, consent to permissions and fetch an ",(0,t.jsx)(n.code,{children:"access_token"}),"\nin the ",(0,t.jsx)(n.code,{children:"JWT"})," format. When the user clicks ",(0,t.jsx)(n.code,{children:"Try out"})," on the APIs, the ",(0,t.jsx)(n.code,{children:"access_token"})," is attached to the header as a ",(0,t.jsx)(n.code,{children:"Bearer "})," token.\nThis is the token the backend will validate."]}),"\n",(0,t.jsx)(n.p,{children:"So, let's set it up!"}),"\n",(0,t.jsx)(n.h3,{id:"step-1---create-app-registration-1",children:"Step 1 - Create app registration"}),"\n",(0,t.jsx)(n.p,{children:"Just like in the previous chapter, we have to create an application registration for our OpenAPI."}),"\n",(0,t.jsxs)(n.p,{children:["Head over to\n",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/registeredApps",children:"Azure -> Azure Entra ID B2C -> App registrations"}),",\nand create a new registration."]}),"\n",(0,t.jsxs)(n.p,{children:["Use the same name, but with ",(0,t.jsx)(n.code,{children:"- OpenAPI"})," appended to it."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Supported account types"}),": ",(0,t.jsx)(n.code,{children:"Accounts in any identity provider or organizational directory (for authenticating users with user flows)"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Redirect URI"}),": Choose ",(0,t.jsx)(n.code,{children:"Single-Page Application (SPA)"})," and ",(0,t.jsx)(n.code,{children:"http://localhost:8000/oauth2-redirect"})," as a value"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Grant admin consent to openid and offline_access permissions"}),": ",(0,t.jsx)(n.code,{children:"Yes"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Register"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"6_application_registration_openapi",src:s(7055).A+"",width:"788",height:"704"})}),"\n",(0,t.jsxs)(n.h3,{id:"step-2---change-token-version-to-v2",children:["Step 2 - Change token version to ",(0,t.jsx)(n.code,{children:"v2"})]}),"\n",(0,t.jsxs)(n.p,{children:["Like last time, we'll verify the token version is set to version 2. In the left menu bar, click ",(0,t.jsx)(n.code,{children:"Manifest"})," and find the line\nthat says ",(0,t.jsx)(n.code,{children:"requestedAccessTokenVersion"}),". Verify the value is ",(0,t.jsx)(n.code,{children:"2"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Press ",(0,t.jsx)(n.strong,{children:"Save"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"3_manifest",src:s(7015).A+"",width:"956",height:"833"})}),"\n",(0,t.jsx)(n.h3,{id:"step-3---note-down-your-application-ids",children:"Step 3 - Note down your application IDs"}),"\n",(0,t.jsxs)(n.p,{children:["Go back to the ",(0,t.jsx)(n.code,{children:"Overview"}),", found in the left menu."]}),"\n",(0,t.jsxs)(n.p,{children:["Copy the ",(0,t.jsx)(n.code,{children:"Application (Client) ID"})," and save it as your ",(0,t.jsx)(n.code,{children:"OPENAPI_CLIENT_ID"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {3}',children:"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"7_overview_openapi",src:s(1095).A+"",width:"728",height:"261"})}),"\n",(0,t.jsx)(n.h3,{id:"step-4---allow-openapi-to-talk-to-the-backend",children:"Step 4 - Allow OpenAPI to talk to the backend"}),"\n",(0,t.jsxs)(n.p,{children:["To allow OpenAPI to talk to the backend API, you must add API permissions to the OpenAPI app registration.\nIn the left menu, go to ",(0,t.jsx)(n.strong,{children:"API Permissions"})," and ",(0,t.jsx)(n.strong,{children:"Add a permission"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"8_api_permissions",src:s(9893).A+"",width:"1182",height:"599"})}),"\n",(0,t.jsxs)(n.p,{children:["Select the ",(0,t.jsx)(n.code,{children:"user_impersonation"})," scope, and press ",(0,t.jsx)(n.strong,{children:"Add a permission"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Your view should now look something like this:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"9_api_permissions_finish",src:s(3640).A+"",width:"773",height:"211"})}),"\n",(0,t.jsx)(n.p,{children:"That's it! Next step is to configure the FastAPI application."}),"\n",(0,t.jsx)(n.h2,{id:"user-flows",children:"User flows"}),"\n",(0,t.jsx)(n.h3,{id:"step-1---create-a-user-flow",children:"Step 1 - Create a user flow"}),"\n",(0,t.jsxs)(n.p,{children:["Head over to\n",(0,t.jsx)(n.a,{href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/userJourneys",children:"Azure -> Azure Entra ID B2C -> Users flows"}),",\nand create a new user flow."]}),"\n",(0,t.jsxs)(n.p,{children:["Select a user flow type of ",(0,t.jsx)(n.code,{children:"Sign up and sign in"})," with the Version ",(0,t.jsx)(n.code,{children:"Recommended"}),", then press ",(0,t.jsx)(n.strong,{children:"Create"}),"."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"10_create_user_flow",src:s(439).A+"",width:"1034",height:"786"})}),"\n",(0,t.jsx)(n.p,{children:"You are prompted to fill out details of the new user flow."}),"\n",(0,t.jsxs)(n.p,{children:["Give it a name of ",(0,t.jsx)(n.code,{children:"sign_up_sign_in"})," (note that ",(0,t.jsx)(n.code,{children:"B2C_1_"})," is already prefixed), and choose ",(0,t.jsx)(n.code,{children:"Email signup"})," as the identity provider."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"11_add_user_flow_props_name_provider",src:s(8911).A+"",width:"1136",height:"505"})}),"\n",(0,t.jsxs)(n.p,{children:["Keep all defaults for now and choose user attributes and token claims as required, and press ",(0,t.jsx)(n.strong,{children:"Create"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"12_add_user_flow_props_attributes_claims",src:s(5018).A+"",width:"1136",height:"505"})}),"\n",(0,t.jsx)(n.h3,{id:"step-2---note-down-your-user-flow-name",children:"Step 2 - Note down your User flow name"}),"\n",(0,t.jsxs)(n.p,{children:["Copy the User Flow name just created (including the ",(0,t.jsx)(n.code,{children:"B2C_1_"})," prefix, e.g. ",(0,t.jsx)(n.code,{children:"B2C_1_sign_up_sign_in"}),")\nand save it in the .env file:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {4}',children:"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=B2C_1_sign_up_sign_in\n"})}),"\n",(0,t.jsx)(n.p,{children:"That's it! Next step is to configure the FastAPI application."})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},439:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/10_add_user_flow-4f94ede054710796f142ddbc0d484a36.png"},8911:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/11_add_user_flow_props_name_provider-2d639bbb11813e95f2b3815432a0e491.png"},5018:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/12_add_user_flow_props_attributes_claims-2d639bbb11813e95f2b3815432a0e491.png"},235:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/1_application_registration-e0432ae88351154e0ca947a0624cdc95.png"},7015:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/2_manifest-21364ccd92d59885e489ebe9a2a118d6.png"},4350:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/3_overview-6b932b348dc81685ff26c87744a4b587.png"},3116:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/4_add_scope-8570a0f3fe23ad97f1d3c8c511c1190b.png"},3402:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/5_add_scope_props-8836a7c4ac6fb55bb82910b81dfd8cae.png"},7055:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/6_application_registration_openapi-0206802d08c99fab3354bf9c4ac34baf.png"},1095:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/7_overview_openapi-5419c10a7d5cd27e7f723c6b30767f23.png"},9893:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/8_api_permissions-63e385274a87959c1469114389a657e7.png"},3640:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/9_api_permissions_finish-f5e93939e843d7d2e779baab01f66c2e.png"},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var t=s(6540);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);