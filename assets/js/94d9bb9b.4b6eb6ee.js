"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[200],{3285:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var s=n(4848),i=n(8453);const o={title:"Azure configuration",sidebar_position:1},a=void 0,r={id:"multi-tenant/azure_setup",title:"Azure configuration",description:"We'll need to create two application registrations for Azure Entra ID authentication to cover both direct API",source:"@site/docs/multi-tenant/azure_setup.mdx",sourceDirName:"multi-tenant",slug:"/multi-tenant/azure_setup",permalink:"/fastapi-azure-auth/multi-tenant/azure_setup",draft:!1,unlisted:!1,editUrl:"https://github.com/Intility/FastAPI-Azure-Auth/edit/main/docs/docs/multi-tenant/azure_setup.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Azure configuration",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"FastAPI configuration",permalink:"/fastapi-azure-auth/single-tenant/fastapi_configuration"},next:{title:"FastAPI configuration",permalink:"/fastapi-azure-auth/multi-tenant/fastapi_configuration"}},c={},d=[{value:"Backend API",id:"backend-api",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids",level:3},{value:"Step 4 - Add an application scope",id:"step-4---add-an-application-scope",level:3},{value:"OpenAPI Documentation",id:"openapi-documentation",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration-1",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2-1",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids-1",level:3},{value:"Step 4 - Allow OpenAPI to talk to the backend",id:"step-4---allow-openapi-to-talk-to-the-backend",level:3}];function l(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"We'll need to create two application registrations for Azure Entra ID authentication to cover both direct API\nuse and usage from the OpenAPI (swagger) documentation."}),"\n",(0,s.jsx)(t.p,{children:"We'll start with the API."}),"\n",(0,s.jsx)(t.h2,{id:"backend-api",children:"Backend API"}),"\n",(0,s.jsx)(t.h3,{id:"step-1---create-app-registration",children:"Step 1 - Create app registration"}),"\n",(0,s.jsxs)(t.p,{children:["Head over to\n",(0,s.jsx)(t.a,{href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps",children:"Azure -> Azure Active Directory -> App registrations"}),",\nand create a new registration."]}),"\n",(0,s.jsx)(t.p,{children:"Select a fitting name for your project; Azure will present the name to the user during consent."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"Supported account types"}),": ",(0,s.jsx)(t.code,{children:"Multitenant"})," -  If you want to create a multi-tenant application, you\nshould head over to the ",(0,s.jsx)(t.a,{href:"/fastapi-azure-auth/multi-tenant/azure_setup",children:"multi-tenant documentation"})]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"1_application_registration",src:n(5318).A+"",width:"891",height:"608"})}),"\n",(0,s.jsxs)(t.p,{children:["Press ",(0,s.jsx)(t.strong,{children:"Register"})]}),"\n",(0,s.jsxs)(t.h3,{id:"step-2---change-token-version-to-v2",children:["Step 2 - Change token version to ",(0,s.jsx)(t.code,{children:"v2"})]}),"\n",(0,s.jsxs)(t.p,{children:["First we'll change the token version to version 2. In the left menu bar, click ",(0,s.jsx)(t.code,{children:"Manifest"})," and find the line\nthat says ",(0,s.jsx)(t.code,{children:"requestedAccessTokenVersion"}),". Change its value from ",(0,s.jsx)(t.code,{children:"null"})," to ",(0,s.jsx)(t.code,{children:"2"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"2_manifest",src:n(1193).A+"",width:"956",height:"833"})}),"\n",(0,s.jsxs)(t.p,{children:["Press ",(0,s.jsx)(t.strong,{children:"Save"})]}),"\n",(0,s.jsx)(t.p,{children:"(This change can take some time to happen, which is why we do this first.)"}),"\n",(0,s.jsx)(t.h3,{id:"step-3---note-down-your-application-ids",children:"Step 3 - Note down your application IDs"}),"\n",(0,s.jsxs)(t.p,{children:["Go back to the ",(0,s.jsx)(t.code,{children:"Overview"}),", found in the left menu."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"3_overview",src:n(6815).A+"",width:"810",height:"357"})}),"\n",(0,s.jsxs)(t.p,{children:["Copy the ",(0,s.jsx)(t.code,{children:"Application (Client) ID"}),", we'll need that for later. I like to use ",(0,s.jsx)(t.code,{children:".env"})," files to\nstore variables like these:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",metastring:'title=".env"',children:"APP_CLIENT_ID=\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-4---add-an-application-scope",children:"Step 4 - Add an application scope"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Go to ",(0,s.jsx)(t.strong,{children:"Expose an API"})," in the left menu bar under your app registration."]}),"\n",(0,s.jsxs)(t.li,{children:["Press ",(0,s.jsx)(t.strong,{children:"+ Add a scope"})]}),"\n",(0,s.jsxs)(t.li,{children:["Press ",(0,s.jsx)(t.strong,{children:"Save and continue"})]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"4_add_scope",src:n(51).A+"",width:"1215",height:"425"})}),"\n",(0,s.jsxs)(t.p,{children:["Add a scope named ",(0,s.jsx)(t.code,{children:"user_impersonation"})," that can be consented by ",(0,s.jsx)(t.code,{children:"Admins and users"}),".\n",(0,s.jsx)(t.img,{alt:"5_add_scope_props",src:n(6901).A+"",width:"583",height:"735"})]}),"\n",(0,s.jsx)(t.p,{children:"You can use the following descriptions:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Access API as user\nAllows the app to access the API as the user.\n\nAccess API as you\nAllows the app to access the API as you.\n"})}),"\n",(0,s.jsx)(t.h2,{id:"openapi-documentation",children:"OpenAPI Documentation"}),"\n",(0,s.jsxs)(t.p,{children:["Our OpenAPI documentation will use the ",(0,s.jsx)(t.code,{children:"Authorization Code Grant Flow, with Proof Key for Code Exchange"})," flow.\nIt's a flow that enables a user of a Single-Page Application to safely log in, consent to permissions and fetch an ",(0,s.jsx)(t.code,{children:"access_token"}),"\nin the ",(0,s.jsx)(t.code,{children:"JWT"})," format. When the user clicks ",(0,s.jsx)(t.code,{children:"Try out"})," on the APIs, the ",(0,s.jsx)(t.code,{children:"access_token"})," is attached to the header as a ",(0,s.jsx)(t.code,{children:"Bearer "})," token.\nThis is the token the backend will validate."]}),"\n",(0,s.jsx)(t.p,{children:"So, let's set it up!"}),"\n",(0,s.jsx)(t.h3,{id:"step-1---create-app-registration-1",children:"Step 1 - Create app registration"}),"\n",(0,s.jsx)(t.p,{children:"Just like in the previous chapter, we have to create an application registration for our OpenAPI."}),"\n",(0,s.jsxs)(t.p,{children:["Head over to\n",(0,s.jsx)(t.a,{href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps",children:"Azure -> Azure Active Directory -> App registrations"}),",\nand create a new registration."]}),"\n",(0,s.jsxs)(t.p,{children:["Use the same name, but with ",(0,s.jsx)(t.code,{children:"- OpenAPI"})," appended to it."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"Supported account types"}),": ",(0,s.jsx)(t.code,{children:"Multitenant"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"Redirect URI"}),": Choose ",(0,s.jsx)(t.code,{children:"Single-Page Application (SPA)"})," and ",(0,s.jsx)(t.code,{children:"http://localhost:8000/oauth2-redirect"})," as a value"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"6_application_registration_openapi",src:n(446).A+"",width:"932",height:"632"})}),"\n",(0,s.jsxs)(t.p,{children:["Press ",(0,s.jsx)(t.strong,{children:"Register"})]}),"\n",(0,s.jsxs)(t.h3,{id:"step-2---change-token-version-to-v2-1",children:["Step 2 - Change token version to ",(0,s.jsx)(t.code,{children:"v2"})]}),"\n",(0,s.jsxs)(t.p,{children:["Like last time, we'll change the token version to version 2. In the left menu bar, click ",(0,s.jsx)(t.code,{children:"Manifest"})," and find the line\nthat says ",(0,s.jsx)(t.code,{children:"requestedAccessTokenVersion"}),". Change its value from ",(0,s.jsx)(t.code,{children:"null"})," to ",(0,s.jsx)(t.code,{children:"2"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"3_manifest",src:n(1193).A+"",width:"956",height:"833"})}),"\n",(0,s.jsxs)(t.p,{children:["Press ",(0,s.jsx)(t.strong,{children:"Save"})]}),"\n",(0,s.jsx)(t.h3,{id:"step-3---note-down-your-application-ids-1",children:"Step 3 - Note down your application IDs"}),"\n",(0,s.jsxs)(t.p,{children:["You should now be redirected to the ",(0,s.jsx)(t.code,{children:"Overview"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"7_overview_openapi",src:n(9810).A+"",width:"1546",height:"189"})}),"\n",(0,s.jsxs)(t.p,{children:["Copy the ",(0,s.jsx)(t.code,{children:"Application (Client) ID"})," and save it as your ",(0,s.jsx)(t.code,{children:"OPENAPI_CLIENT_ID"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",metastring:'title=".env" {2}',children:"APP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-4---allow-openapi-to-talk-to-the-backend",children:"Step 4 - Allow OpenAPI to talk to the backend"}),"\n",(0,s.jsxs)(t.p,{children:["To allow OpenAPI to talk to the backend API, you must add API permissions to the OpenAPI app registration.\nIn the left menu, go to ",(0,s.jsx)(t.strong,{children:"API Permissions"})," and ",(0,s.jsx)(t.strong,{children:"Add a permission"}),"."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"8_api_permissions",src:n(3142).A+"",width:"1090",height:"753"})}),"\n",(0,s.jsxs)(t.p,{children:["Select the ",(0,s.jsx)(t.code,{children:"user_impersonation"})," scope, and press ",(0,s.jsx)(t.strong,{children:"Add a permission"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Your view should now look something like this:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"9_api_permissions_finish",src:n(8561).A+"",width:"1037",height:"184"})}),"\n",(0,s.jsx)(t.p,{children:"That's it! Next step is to configure the FastAPI application."})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},5318:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/1_application_registration-08a8c9f21a45b6d578d8d15631946edf.png"},6815:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/3_overview-1e1a668b849eaf31ce7b058e64bf0660.png"},51:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/4_add_scope-575b44371cf4e5e81231943a741d34c5.png"},6901:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/5_add_scope_props-840ca51c787286fc24e65ae01049920a.png"},446:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/6_application_registration_openapi-ec97c895923720a777cce453ed591161.png"},9810:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/7_overview_openapi-7c3d17d5eb24caedf1269daba48b8b6c.png"},3142:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/8_api_permissions-8c47c586e9521d5e897fc1884b82ab1a.png"},8561:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/9_api_permissions_finish-48d03b99688420c25d45a2bb31569f34.png"},1193:(e,t,n)=>{n.d(t,{A:()=>s});const s=n.p+"assets/images/2_manifest-21364ccd92d59885e489ebe9a2a118d6.png"},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var s=n(6540);const i={},o=s.createContext(i);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);