"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[717],{4504:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var s=t(4848),i=t(8453);const o={title:"Azure configuration",sidebar_position:1},a=void 0,r={id:"single-tenant/azure_setup",title:"Azure configuration",description:"We'll need to create two application registrations for Azure Entra ID authentication to cover both direct API",source:"@site/docs/single-tenant/azure_setup.mdx",sourceDirName:"single-tenant",slug:"/single-tenant/azure_setup",permalink:"/fastapi-azure-auth/single-tenant/azure_setup",draft:!1,unlisted:!1,editUrl:"https://github.com/Intility/FastAPI-Azure-Auth/edit/main/docs/docs/single-tenant/azure_setup.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Azure configuration",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Installation",permalink:"/fastapi-azure-auth/installation"},next:{title:"FastAPI configuration",permalink:"/fastapi-azure-auth/single-tenant/fastapi_configuration"}},c={},d=[{value:"Backend API",id:"backend-api",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids",level:3},{value:"Step 4 - Add an application scope",id:"step-4---add-an-application-scope",level:3},{value:"OpenAPI Documentation",id:"openapi-documentation",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration-1",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2-1",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids-1",level:3},{value:"Step 4 - Allow OpenAPI to talk to the backend",id:"step-4---allow-openapi-to-talk-to-the-backend",level:3}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"We'll need to create two application registrations for Azure Entra ID authentication to cover both direct API\nuse and usage from the OpenAPI (swagger) documentation."}),"\n",(0,s.jsx)(n.p,{children:"We'll start with the API."}),"\n",(0,s.jsx)(n.h2,{id:"backend-api",children:"Backend API"}),"\n",(0,s.jsx)(n.h3,{id:"step-1---create-app-registration",children:"Step 1 - Create app registration"}),"\n",(0,s.jsxs)(n.p,{children:["Head over to\n",(0,s.jsx)(n.a,{href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps",children:"Azure -> Azure Active Directory -> App registrations"}),",\nand create a new registration."]}),"\n",(0,s.jsx)(n.p,{children:"Select a fitting name for your project; Azure will present the name to the user during consent."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Supported account types"}),": ",(0,s.jsx)(n.code,{children:"Single tenant"})," -  If you want to create a multi-tenant application, you\nshould head over to the ",(0,s.jsx)(n.a,{href:"/fastapi-azure-auth/multi-tenant/azure_setup",children:"multi-tenant documentation"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Press ",(0,s.jsx)(n.strong,{children:"Register"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"1_application_registration",src:t(9285).A+"",width:"893",height:"574"})}),"\n",(0,s.jsxs)(n.h3,{id:"step-2---change-token-version-to-v2",children:["Step 2 - Change token version to ",(0,s.jsx)(n.code,{children:"v2"})]}),"\n",(0,s.jsxs)(n.p,{children:["First we'll change the token version to version 2. In the left menu bar, click ",(0,s.jsx)(n.code,{children:"Manifest"})," and find the line\nthat says ",(0,s.jsx)(n.code,{children:"requestedAccessTokenVersion"}),". Change its value from ",(0,s.jsx)(n.code,{children:"null"})," to ",(0,s.jsx)(n.code,{children:"2"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Press ",(0,s.jsx)(n.strong,{children:"Save"})]}),"\n",(0,s.jsx)(n.p,{children:"(This change can take some time to happen, which is why we do this first.)"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"2_manifest",src:t(1193).A+"",width:"956",height:"833"})}),"\n",(0,s.jsx)(n.h3,{id:"step-3---note-down-your-application-ids",children:"Step 3 - Note down your application IDs"}),"\n",(0,s.jsxs)(n.p,{children:["Go back to the ",(0,s.jsx)(n.code,{children:"Overview"}),", found in the left menu."]}),"\n",(0,s.jsxs)(n.p,{children:["Copy the ",(0,s.jsx)(n.code,{children:"Application (Client) ID"})," and ",(0,s.jsx)(n.code,{children:"Directory (tenant) ID"}),", we'll need these for later. I like to use ",(0,s.jsx)(n.code,{children:".env"})," files to\nstore variables like these:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {1,2}',children:"TENANT_ID=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"3_overview",src:t(7416).A+"",width:"934",height:"344"})}),"\n",(0,s.jsx)(n.h3,{id:"step-4---add-an-application-scope",children:"Step 4 - Add an application scope"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Go to ",(0,s.jsx)(n.strong,{children:"Expose an API"})," in the left menu bar under your app registration."]}),"\n",(0,s.jsxs)(n.li,{children:["Press ",(0,s.jsx)(n.strong,{children:"+ Add a scope"})]}),"\n",(0,s.jsxs)(n.li,{children:["You'll be prompted to set an Application ID URI, leave the suggested one and press ",(0,s.jsx)(n.strong,{children:"Save and continue"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"4_add_scope",src:t(8570).A+"",width:"1210",height:"899"})}),"\n",(0,s.jsxs)(n.p,{children:["Add a scope named ",(0,s.jsx)(n.code,{children:"user_impersonation"})," that can be consented by ",(0,s.jsx)(n.code,{children:"Admins and users"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"You can use the following descriptions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"Access API as user\nAllows the app to access the API as the user.\n\nAccess API as you\nAllows the app to access the API as you.\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"5_add_scope_props",src:t(3512).A+"",width:"577",height:"728"})}),"\n",(0,s.jsx)(n.h2,{id:"openapi-documentation",children:"OpenAPI Documentation"}),"\n",(0,s.jsxs)(n.p,{children:["Our OpenAPI documentation will use the ",(0,s.jsx)(n.code,{children:"Authorization Code Grant Flow, with Proof Key for Code Exchange"})," flow.\nIt's a flow that enables a user of a Single-Page Application to safely log in, consent to permissions and fetch an ",(0,s.jsx)(n.code,{children:"access_token"}),"\nin the ",(0,s.jsx)(n.code,{children:"JWT"})," format. When the user clicks ",(0,s.jsx)(n.code,{children:"Try out"})," on the APIs, the ",(0,s.jsx)(n.code,{children:"access_token"})," is attached to the header as a ",(0,s.jsx)(n.code,{children:"Bearer "})," token.\nThis is the token the backend will validate."]}),"\n",(0,s.jsx)(n.p,{children:"So, let's set it up!"}),"\n",(0,s.jsx)(n.h3,{id:"step-1---create-app-registration-1",children:"Step 1 - Create app registration"}),"\n",(0,s.jsx)(n.p,{children:"Just like in the previous chapter, we have to create an application registration for our OpenAPI."}),"\n",(0,s.jsxs)(n.p,{children:["Head over to\n",(0,s.jsx)(n.a,{href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps",children:"Azure -> Azure Active Directory -> App registrations"}),",\nand create a new registration."]}),"\n",(0,s.jsxs)(n.p,{children:["Use the same name, but with ",(0,s.jsx)(n.code,{children:"- OpenAPI"})," appended to it."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Supported account types"}),": ",(0,s.jsx)(n.code,{children:"Single tenant"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Redirect URI"}),": Choose ",(0,s.jsx)(n.code,{children:"Single-Page Application (SPA)"})," and ",(0,s.jsx)(n.code,{children:"http://localhost:8000/oauth2-redirect"})," as a value"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Press ",(0,s.jsx)(n.strong,{children:"Register"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"6_application_registration_openapi",src:t(9897).A+"",width:"882",height:"650"})}),"\n",(0,s.jsxs)(n.h3,{id:"step-2---change-token-version-to-v2-1",children:["Step 2 - Change token version to ",(0,s.jsx)(n.code,{children:"v2"})]}),"\n",(0,s.jsxs)(n.p,{children:["Like last time, we'll change the token version to version 2. In the left menu bar, click ",(0,s.jsx)(n.code,{children:"Manifest"})," and find the line\nthat says ",(0,s.jsx)(n.code,{children:"requestedAccessTokenVersion"}),". Change its value from ",(0,s.jsx)(n.code,{children:"null"})," to ",(0,s.jsx)(n.code,{children:"2"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Press ",(0,s.jsx)(n.strong,{children:"Save"})]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"3_manifest",src:t(1193).A+"",width:"956",height:"833"})}),"\n",(0,s.jsx)(n.h3,{id:"step-3---note-down-your-application-ids-1",children:"Step 3 - Note down your application IDs"}),"\n",(0,s.jsxs)(n.p,{children:["Go back to the ",(0,s.jsx)(n.code,{children:"Overview"}),", found in the left menu."]}),"\n",(0,s.jsxs)(n.p,{children:["Copy the ",(0,s.jsx)(n.code,{children:"Application (Client) ID"})," and save it as your ",(0,s.jsx)(n.code,{children:"OPENAPI_CLIENT_ID"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title=".env" {3}',children:"TENANT_ID=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"7_overview_openapi",src:t(9306).A+"",width:"1524",height:"203"})}),"\n",(0,s.jsx)(n.h3,{id:"step-4---allow-openapi-to-talk-to-the-backend",children:"Step 4 - Allow OpenAPI to talk to the backend"}),"\n",(0,s.jsxs)(n.p,{children:["To allow OpenAPI to talk to the backend API, you must add API permissions to the OpenAPI app registration.\nIn the left menu, go to ",(0,s.jsx)(n.strong,{children:"API Permissions"})," and ",(0,s.jsx)(n.strong,{children:"Add a permission"}),"."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"8_api_permissions",src:t(7599).A+"",width:"1163",height:"725"})}),"\n",(0,s.jsxs)(n.p,{children:["Select the ",(0,s.jsx)(n.code,{children:"user_impersonation"})," scope, and press ",(0,s.jsx)(n.strong,{children:"Add a permission"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Your view should now look something like this:"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"9_api_permissions_finish",src:t(4646).A+"",width:"1037",height:"184"})}),"\n",(0,s.jsx)(n.p,{children:"That's it! Next step is to configure the FastAPI application."})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},9285:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/1_application_registration-3f2f5fa3e90e42159f55548506d721de.png"},1193:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/2_manifest-21364ccd92d59885e489ebe9a2a118d6.png"},7416:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/3_overview-645be70b19834d6652531701c5589761.png"},8570:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/4_add_scope-b92ca374688a71c50520829f7141e39c.png"},3512:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/5_add_scope_props-5102f17459906ae9347cf18bc2d89b74.png"},9897:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/6_application_registration_openapi-ce91c522a3b2e19f85b410b500aa714d.png"},9306:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/7_overview_openapi-01564c0cdbcd18d11059037f96e177e6.png"},7599:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/8_api_permissions-fe3b2a5164249990612a022c10bdcca5.png"},4646:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/9_api_permissions_finish-48d03b99688420c25d45a2bb31569f34.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(6540);const i={},o=s.createContext(i);function a(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);