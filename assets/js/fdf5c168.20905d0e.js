"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[992],{702:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var s=t(4848),i=t(8453);const o={title:"Calling your APIs from Python",sidebar_position:4},r=void 0,a={id:"usage-and-faq/calling_your_apis_from_python",title:"Calling your APIs from Python",description:"Azure setup",source:"@site/docs/usage-and-faq/calling_your_apis_from_python.mdx",sourceDirName:"usage-and-faq",slug:"/usage-and-faq/calling_your_apis_from_python",permalink:"/fastapi-azure-auth/usage-and-faq/calling_your_apis_from_python",draft:!1,unlisted:!1,editUrl:"https://github.com/Intility/FastAPI-Azure-Auth/edit/main/docs/docs/usage-and-faq/calling_your_apis_from_python.mdx",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Calling your APIs from Python",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Locking down on roles",permalink:"/fastapi-azure-auth/usage-and-faq/locking_down_on_roles"},next:{title:"Using Microsoft Graph",permalink:"/fastapi-azure-auth/usage-and-faq/graph_usage"}},c={},l=[{value:"Azure setup",id:"azure-setup",level:2},{value:"FastAPI setup",id:"fastapi-setup",level:2},{value:"Single- and multi-tenant",id:"single--and-multi-tenant",level:3},{value:"B2C",id:"b2c",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"azure-setup",children:"Azure setup"}),"\n",(0,s.jsxs)(n.p,{children:["In order to call your APIs from Python (or any other backend), you should use the ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow",children:"Client Credential Flow"}),"."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Navigate to ",(0,s.jsx)(n.a,{href:"https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps",children:"Azure -> Azure Active Directory -> App registrations"}),"\nand find your ",(0,s.jsx)(n.strong,{children:"OpenAPI application registration"}),"*"]}),"\n",(0,s.jsxs)(n.li,{children:["Navigate over to ",(0,s.jsx)(n.code,{children:"Certificate & secrets"})]}),"\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"New client secret"})]}),"\n",(0,s.jsx)(n.li,{children:"Give it a name and an expiry time"}),"\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.code,{children:"Add"})]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["In this example, we used the already created OpenAPI app registration in order to keep it short,\nbut in reality you should ",(0,s.jsx)(n.strong,{children:"create a new app registration"})," for ",(0,s.jsx)(n.em,{children:"every"})," application talking to your backend.\nIn other words, if someone wants to use your API, they should create their own app registration and their own secret."]})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"secret_picture",src:t(6661).A+"",width:"1687",height:"817"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsx)(n.p,{children:"You can use client certificates too, but we won't cover this here."})}),"\n",(0,s.jsxs)(n.ol,{start:"6",children:["\n",(0,s.jsx)(n.li,{children:"Copy the secret and save it for later."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"copy_secret",src:t(6466).A+"",width:"1019",height:"146"})}),"\n",(0,s.jsx)(n.h2,{id:"fastapi-setup",children:"FastAPI setup"}),"\n",(0,s.jsx)(n.p,{children:"The basic process is to first fetch the access token from Azure, and then call your own API endpoint."}),"\n",(0,s.jsx)(n.h3,{id:"single--and-multi-tenant",children:"Single- and multi-tenant"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="my_script.py"',children:"import asyncio\nfrom httpx import AsyncClient\nfrom demo_project.core.config import settings\n\nasync def main():\n    async with AsyncClient() as client:\n        azure_response = await client.post(\n            url=f'https://login.microsoftonline.com/{settings.TENANT_ID}/oauth2/v2.0/token',\n            data={\n                'grant_type': 'client_credentials',\n                'client_id': settings.OPENAPI_CLIENT_ID,  # the ID of the app reg you created the secret for\n                'client_secret': settings.CLIENT_SECRET,  # the secret you created\n                'scope': f'api://{settings.APP_CLIENT_ID}/.default',  # note: NOT .user_impersonation\n            }\n        )\n        token = azure_response.json()['access_token']\n\n        my_api_response = await client.get(\n            'http://localhost:8000/api/v1/hello-graph',\n            headers={'Authorization': f'Bearer {token}'},\n        )\n        print(my_api_response.json())\n\nif __name__ == '__main__':\n    asyncio.run(main())\n"})}),"\n",(0,s.jsx)(n.h3,{id:"b2c",children:"B2C"}),"\n",(0,s.jsxs)(n.p,{children:["Compared to the above, the only differences are the ",(0,s.jsx)(n.code,{children:"scope"})," and ",(0,s.jsx)(n.code,{children:"url"})," parameters:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="my_script.py"',children:"import asyncio\nfrom httpx import AsyncClient\nfrom demo_project.core.config import settings\n\nasync def main():\n    async with AsyncClient() as client:\n        azure_response = await client.post(\n            url=f'https://{settings.TENANT_NAME}.b2clogin.com/{settings.TENANT_NAME}.onmicrosoft.com/{settings.AUTH_POLICY_NAME}/oauth2/v2.0/token',\n            data={\n                'grant_type': 'client_credentials',\n                'client_id': settings.OPENAPI_CLIENT_ID,  # the ID of the app reg you created the secret for\n                'client_secret': settings.CLIENT_SECRET,  # the secret you created\n                'scope': f'https://{settings.TENANT_NAME}.onmicrosoft.com/{settings.APP_CLIENT_ID}/.default',\n            }\n        )\n        token = azure_response.json()['access_token']\n\n        my_api_response = await client.get(\n            'http://localhost:8000/api/v1/hello-graph',\n            headers={'Authorization': f'Bearer {token}'},\n        )\n        print(my_api_response.json())\n\nif __name__ == '__main__':\n    asyncio.run(main())\n\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},6466:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/copy_secret-072e70a6c05d4b02eba87aead020c095.png"},6661:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/secret_picture-bff174b193d466b064a14fe6d405fd6a.png"},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(6540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);