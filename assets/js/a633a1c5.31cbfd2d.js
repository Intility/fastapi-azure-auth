"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[303],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>k});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),l=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=l(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),c=l(n),m=i,k=c["".concat(s,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(k,r(r({ref:t},d),{},{components:n})):a.createElement(k,r({ref:t},d))}));function k(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=m;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p[c]="string"==typeof e?e:i,r[1]=p;for(var l=2;l<o;l++)r[l]=n[l];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7651:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>p,toc:()=>l});var a=n(7462),i=(n(7294),n(3905));const o={title:"Azure configuration",sidebar_position:1},r=void 0,p={unversionedId:"b2c/azure_setup",id:"b2c/azure_setup",title:"Azure configuration",description:"We'll need to create two application registrations for Azure AD B2C authentication to cover both direct API",source:"@site/docs/b2c/azure_setup.mdx",sourceDirName:"b2c",slug:"/b2c/azure_setup",permalink:"/fastapi-azure-auth/b2c/azure_setup",editUrl:"https://github.com/Intility/FastAPI-Azure-Auth/edit/main/docs/docs/b2c/azure_setup.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Azure configuration",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Accept specific tenants only",permalink:"/fastapi-azure-auth/multi-tenant/accept_specific_tenants_only"},next:{title:"FastAPI configuration",permalink:"/fastapi-azure-auth/b2c/fastapi_configuration"}},s={},l=[{value:"Backend API",id:"backend-api",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration",level:3},{value:"Step 2 - Verify token version is <code>v2</code>",id:"step-2---verify-token-version-is-v2",level:3},{value:"Step 3 - Note down your tenant name and application ID",id:"step-3---note-down-your-tenant-name-and-application-id",level:3},{value:"Step 4 - Add an application scope",id:"step-4---add-an-application-scope",level:3},{value:"OpenAPI Documentation",id:"openapi-documentation",level:2},{value:"Step 1 - Create app registration",id:"step-1---create-app-registration-1",level:3},{value:"Step 2 - Change token version to <code>v2</code>",id:"step-2---change-token-version-to-v2",level:3},{value:"Step 3 - Note down your application IDs",id:"step-3---note-down-your-application-ids",level:3},{value:"Step 4 - Allow OpenAPI to talk to the backend",id:"step-4---allow-openapi-to-talk-to-the-backend",level:3},{value:"User flows",id:"user-flows",level:2},{value:"Step 1 - Create a user flow",id:"step-1---create-a-user-flow",level:3},{value:"Step 2 - Note down your User flow name",id:"step-2---note-down-your-user-flow-name",level:3}],d={toc:l},c="wrapper";function u(e){let{components:t,...o}=e;return(0,i.kt)(c,(0,a.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"We'll need to create two application registrations for Azure AD B2C authentication to cover both direct API\nuse and usage from the OpenAPI (swagger) documentation."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"This guide assumes that an Azure B2C tenant was already created and linked to an Azure subscription."))),(0,i.kt)("h2",{id:"backend-api"},"Backend API"),(0,i.kt)("h3",{id:"step-1---create-app-registration"},"Step 1 - Create app registration"),(0,i.kt)("p",null,"Head over to\n",(0,i.kt)("a",{parentName:"p",href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/registeredApps"},"Azure -> Azure AD B2C -> App registrations"),",\nand create a new registration."),(0,i.kt)("p",null,"Select a fitting name for your project; Azure will present the name to the user during consent."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Supported account types"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Accounts in any identity provider or organizational directory (for authenticating users with user flows)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Redirect URI"),": Choose ",(0,i.kt)("inlineCode",{parentName:"li"},"Web")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"http://localhost:8000/signin-oidc")," as a value"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Grant admin consent to openid and offline_access permissions"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Yes"))),(0,i.kt)("p",null,"Press ",(0,i.kt)("strong",{parentName:"p"},"Register")),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"1_application_registration",src:n(3655).Z,width:"1181",height:"620"})),(0,i.kt)("h3",{id:"step-2---verify-token-version-is-v2"},"Step 2 - Verify token version is ",(0,i.kt)("inlineCode",{parentName:"h3"},"v2")),(0,i.kt)("p",null,"First we'll verify that the token version is version 2. In the left menu bar, click ",(0,i.kt)("inlineCode",{parentName:"p"},"Manifest")," and find the line\nthat says ",(0,i.kt)("inlineCode",{parentName:"p"},"accessTokenAcceptedVersion"),". Verify that the value is ",(0,i.kt)("inlineCode",{parentName:"p"},"2"),"."),(0,i.kt)("p",null,"Press ",(0,i.kt)("strong",{parentName:"p"},"Save")),(0,i.kt)("p",null,"(A change can take some time to happen, which is why we do this first.)"),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"2_manifest",src:n(1501).Z,width:"822",height:"447"})),(0,i.kt)("h3",{id:"step-3---note-down-your-tenant-name-and-application-id"},"Step 3 - Note down your tenant name and application ID"),(0,i.kt)("p",null,"Go back to the App Registration ",(0,i.kt)("inlineCode",{parentName:"p"},"Overview"),", found in the left menu."),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"3_overview",src:n(8566).Z,width:"928",height:"343"})),(0,i.kt)("p",null,"Copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"Application (Client) ID"),", we'll need it for later. I like to use ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," files to\nstore variables like these:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=".env" {2}',title:'".env"',"{2}":!0},"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n")),(0,i.kt)("p",null,"Also, in the Azure AD B2C overview get the tenant name from the domain name (without the ",(0,i.kt)("inlineCode",{parentName:"p"},".onmicrosoft.com")," part)\nand add it to the ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," file as well:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=".env" {1}',title:'".env"',"{1}":!0},"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n")),(0,i.kt)("h3",{id:"step-4---add-an-application-scope"},"Step 4 - Add an application scope"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Go to ",(0,i.kt)("strong",{parentName:"p"},"Expose an API")," in the left menu bar under your app registration.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Press ",(0,i.kt)("strong",{parentName:"p"},"+ Add a scope"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"You'll be prompted to set an Application ID URI, leave the suggested one and press ",(0,i.kt)("strong",{parentName:"p"},"Save and continue"),"\n",(0,i.kt)("img",{loading:"lazy",alt:"4_add_scope",src:n(3443).Z,width:"1137",height:"560"}))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"You'll be prompted to set a scope name, display name and description. Set the scope name to ",(0,i.kt)("inlineCode",{parentName:"p"},"user_impersonation"),",\ndisplay name to ",(0,i.kt)("inlineCode",{parentName:"p"},"Access API as user")," and description to ",(0,i.kt)("inlineCode",{parentName:"p"},"Allows the app to access the API as the user."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Make sure the State is ",(0,i.kt)("inlineCode",{parentName:"p"},"Enabled"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Press ",(0,i.kt)("strong",{parentName:"p"},"Add scope")))),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"5_add_scope_props",src:n(6740).Z,width:"573",height:"535"})),(0,i.kt)("h2",{id:"openapi-documentation"},"OpenAPI Documentation"),(0,i.kt)("p",null,"Our OpenAPI documentation will use the ",(0,i.kt)("inlineCode",{parentName:"p"},"Authorization Code Grant Flow, with Proof Key for Code Exchange")," flow.\nIt's a flow that enables a user of a Single-Page Application to safely log in, consent to permissions and fetch an ",(0,i.kt)("inlineCode",{parentName:"p"},"access_token"),"\nin the ",(0,i.kt)("inlineCode",{parentName:"p"},"JWT")," format. When the user clicks ",(0,i.kt)("inlineCode",{parentName:"p"},"Try out")," on the APIs, the ",(0,i.kt)("inlineCode",{parentName:"p"},"access_token")," is attached to the header as a ",(0,i.kt)("inlineCode",{parentName:"p"},"Bearer ")," token.\nThis is the token the backend will validate."),(0,i.kt)("p",null,"So, let's set it up!"),(0,i.kt)("h3",{id:"step-1---create-app-registration-1"},"Step 1 - Create app registration"),(0,i.kt)("p",null,"Just like in the previous chapter, we have to create an application registration for our OpenAPI."),(0,i.kt)("p",null,"Head over to\n",(0,i.kt)("a",{parentName:"p",href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/registeredApps"},"Azure -> Azure AD B2C -> App registrations"),",\nand create a new registration."),(0,i.kt)("p",null,"Use the same name, but with ",(0,i.kt)("inlineCode",{parentName:"p"},"- OpenAPI")," appended to it."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Supported account types"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Accounts in any identity provider or organizational directory (for authenticating users with user flows)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Redirect URI"),": Choose ",(0,i.kt)("inlineCode",{parentName:"li"},"Single-Page Application (SPA)")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"http://localhost:8000/oauth2-redirect")," as a value"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Grant admin consent to openid and offline_access permissions"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"Yes"))),(0,i.kt)("p",null,"Press ",(0,i.kt)("strong",{parentName:"p"},"Register")),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"6_application_registration_openapi",src:n(5130).Z,width:"788",height:"704"})),(0,i.kt)("h3",{id:"step-2---change-token-version-to-v2"},"Step 2 - Change token version to ",(0,i.kt)("inlineCode",{parentName:"h3"},"v2")),(0,i.kt)("p",null,"Like last time, we'll verify the token version is set to version 2. In the left menu bar, click ",(0,i.kt)("inlineCode",{parentName:"p"},"Manifest")," and find the line\nthat says ",(0,i.kt)("inlineCode",{parentName:"p"},"accessTokenAcceptedVersion"),". Verify the value is ",(0,i.kt)("inlineCode",{parentName:"p"},"2"),"."),(0,i.kt)("p",null,"Press ",(0,i.kt)("strong",{parentName:"p"},"Save")),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"3_manifest",src:n(1501).Z,width:"822",height:"447"})),(0,i.kt)("h3",{id:"step-3---note-down-your-application-ids"},"Step 3 - Note down your application IDs"),(0,i.kt)("p",null,"Go back to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Overview"),", found in the left menu."),(0,i.kt)("p",null,"Copy the ",(0,i.kt)("inlineCode",{parentName:"p"},"Application (Client) ID")," and save it as your ",(0,i.kt)("inlineCode",{parentName:"p"},"OPENAPI_CLIENT_ID"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=".env" {3}',title:'".env"',"{3}":!0},"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=\n")),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"7_overview_openapi",src:n(473).Z,width:"728",height:"261"})),(0,i.kt)("h3",{id:"step-4---allow-openapi-to-talk-to-the-backend"},"Step 4 - Allow OpenAPI to talk to the backend"),(0,i.kt)("p",null,"To allow OpenAPI to talk to the backend API, you must add API permissions to the OpenAPI app registration.\nIn the left menu, go to ",(0,i.kt)("strong",{parentName:"p"},"API Permissions")," and ",(0,i.kt)("strong",{parentName:"p"},"Add a permission"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"8_api_permissions",src:n(9426).Z,width:"1182",height:"599"})),(0,i.kt)("p",null,"Select the ",(0,i.kt)("inlineCode",{parentName:"p"},"user_impersonation")," scope, and press ",(0,i.kt)("strong",{parentName:"p"},"Add a permission"),"."),(0,i.kt)("p",null,"Your view should now look something like this:"),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"9_api_permissions_finish",src:n(7502).Z,width:"773",height:"211"})),(0,i.kt)("p",null,"That's it! Next step is to configure the FastAPI application."),(0,i.kt)("h2",{id:"user-flows"},"User flows"),(0,i.kt)("h3",{id:"step-1---create-a-user-flow"},"Step 1 - Create a user flow"),(0,i.kt)("p",null,"Head over to\n",(0,i.kt)("a",{parentName:"p",href:"https://portal.azure.com/#view/Microsoft_AAD_B2CAdmin/TenantManagementMenuBlade/~/userJourneys"},"Azure -> Azure AD B2C -> Users flows"),",\nand create a new user flow."),(0,i.kt)("p",null,"Select a user flow type of ",(0,i.kt)("inlineCode",{parentName:"p"},"Sign up and sign in")," with the Version ",(0,i.kt)("inlineCode",{parentName:"p"},"Recommended"),", then press ",(0,i.kt)("strong",{parentName:"p"},"Create"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"10_create_user_flow",src:n(3805).Z,width:"1034",height:"786"})),(0,i.kt)("p",null,"You are prompted to fill out details of the new user flow."),(0,i.kt)("p",null,"Give it a name of ",(0,i.kt)("inlineCode",{parentName:"p"},"sign_up_sign_in")," (note that ",(0,i.kt)("inlineCode",{parentName:"p"},"B2C_1_")," is already prefixed), and choose ",(0,i.kt)("inlineCode",{parentName:"p"},"Email signup")," as the identity provider."),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"11_add_user_flow_props_name_provider",src:n(4182).Z,width:"1136",height:"505"})),(0,i.kt)("p",null,"Keep all defaults for now and choose user attributes and token claims as required, and press ",(0,i.kt)("strong",{parentName:"p"},"Create")),(0,i.kt)("p",null,(0,i.kt)("img",{loading:"lazy",alt:"12_add_user_flow_props_attributes_claims",src:n(381).Z,width:"1136",height:"505"})),(0,i.kt)("h3",{id:"step-2---note-down-your-user-flow-name"},"Step 2 - Note down your User flow name"),(0,i.kt)("p",null,"Copy the User Flow name just created (including the ",(0,i.kt)("inlineCode",{parentName:"p"},"B2C_1_")," prefix, e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"B2C_1_sign_up_sign_in"),")\nand save it in the .env file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash",metastring:'title=".env" {4}',title:'".env"',"{4}":!0},"TENANT_NAME=\nAPP_CLIENT_ID=\nOPENAPI_CLIENT_ID=\nAUTH_POLICY_NAME=B2C_1_sign_up_sign_in\n")),(0,i.kt)("p",null,"That's it! Next step is to configure the FastAPI application."))}u.isMDXComponent=!0},3805:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/10_add_user_flow-4f94ede054710796f142ddbc0d484a36.png"},4182:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/11_add_user_flow_props_name_provider-2d639bbb11813e95f2b3815432a0e491.png"},381:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/12_add_user_flow_props_attributes_claims-2d639bbb11813e95f2b3815432a0e491.png"},3655:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/1_application_registration-e0432ae88351154e0ca947a0624cdc95.png"},1501:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/2_manifest-efbb3b3fa2c3711a92482f13d9249a3c.png"},8566:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/3_overview-6b932b348dc81685ff26c87744a4b587.png"},3443:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/4_add_scope-8570a0f3fe23ad97f1d3c8c511c1190b.png"},6740:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/5_add_scope_props-8836a7c4ac6fb55bb82910b81dfd8cae.png"},5130:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/6_application_registration_openapi-0206802d08c99fab3354bf9c4ac34baf.png"},473:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/7_overview_openapi-5419c10a7d5cd27e7f723c6b30767f23.png"},9426:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/8_api_permissions-63e385274a87959c1469114389a657e7.png"},7502:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/9_api_permissions_finish-f5e93939e843d7d2e779baab01f66c2e.png"}}]);